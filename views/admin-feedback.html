<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback Admin â€” MeetingMind</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .admin-container { max-width: 960px; margin: 0 auto; padding: 24px 20px; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .admin-header h1 { font-size: 1.5rem; margin: 0; }
    .admin-filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .admin-filters select, .admin-filters input {
      padding: 8px 12px; border: 1px solid #d0d0d0; border-radius: 6px;
      font-size: 0.85rem; font-family: inherit;
    }
    .admin-filters select:focus, .admin-filters input:focus {
      outline: none; border-color: #4361ee;
    }
    .fb-card {
      background: #fff; border: 1px solid #e8e8e8; border-radius: 8px;
      padding: 16px 20px; margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .fb-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap; }
    .fb-meta { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .fb-badge {
      display: inline-block; padding: 2px 8px; border-radius: 10px;
      font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
    }
    .fb-badge.cat-feature { background: #e8f0fe; color: #1a73e8; }
    .fb-badge.cat-bug { background: #fce8e6; color: #d93025; }
    .fb-badge.cat-other { background: #f1f3f4; color: #5f6368; }
    .fb-badge.sev-low { background: #e6f4ea; color: #137333; }
    .fb-badge.sev-medium { background: #fef7e0; color: #b06000; }
    .fb-badge.sev-high { background: #fce8e6; color: #c5221f; }
    .fb-badge.st-new { background: #e8f0fe; color: #1a73e8; }
    .fb-badge.st-reviewed { background: #fef7e0; color: #b06000; }
    .fb-badge.st-closed { background: #f1f3f4; color: #5f6368; }
    .fb-email { font-size: 0.85rem; color: #555; }
    .fb-date { font-size: 0.8rem; color: #999; }
    .fb-message { margin: 10px 0; white-space: pre-wrap; font-size: 0.9rem; line-height: 1.6; color: #333; }
    .fb-details { font-size: 0.8rem; color: #888; margin-bottom: 8px; }
    .fb-details a { color: #4361ee; }
    .fb-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .fb-actions button { font-size: 0.8rem; }
    .fb-screenshot-thumb {
      display: inline-block; margin-top: 8px;
      max-width: 200px; max-height: 120px;
      border: 1px solid #e0e0e0; border-radius: 4px; cursor: pointer;
    }
    .fb-empty { text-align: center; color: #888; padding: 40px; font-size: 0.95rem; }
    .fb-count { font-size: 0.85rem; color: #888; }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="/dashboard.html" class="logo">MeetingMind</a>
    <nav>
      <span style="font-size:0.85rem;color:#888">Admin</span>
      <a href="/dashboard.html" class="btn btn-secondary btn-small">Dashboard</a>
    </nav>
  </div>

  <div class="admin-container">
    <div class="admin-header">
      <h1>Feedback Inbox</h1>
      <span class="fb-count" id="fb-count"></span>
    </div>

    <div class="admin-filters">
      <select id="filter-status">
        <option value="">All statuses</option>
        <option value="new" selected>New</option>
        <option value="reviewed">Reviewed</option>
        <option value="closed">Closed</option>
      </select>
      <select id="filter-category">
        <option value="">All categories</option>
        <option value="feature">Feature</option>
        <option value="bug">Bug</option>
        <option value="other">Other</option>
      </select>
      <select id="filter-severity">
        <option value="">All severities</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
      <input type="text" id="filter-search" placeholder="Search messages/emails...">
    </div>

    <div id="fb-list"></div>
  </div>

  <script>
    const listEl = document.getElementById('fb-list');
    const countEl = document.getElementById('fb-count');

    async function loadFeedback() {
      const params = new URLSearchParams();
      const status = document.getElementById('filter-status').value;
      const category = document.getElementById('filter-category').value;
      const severity = document.getElementById('filter-severity').value;
      const q = document.getElementById('filter-search').value.trim();
      if (status) params.set('status', status);
      if (category) params.set('category', category);
      if (severity) params.set('severity', severity);
      if (q) params.set('q', q);

      const res = await fetch('/api/feedback/admin?' + params.toString());
      if (res.status === 403) {
        listEl.innerHTML = '<div class="fb-empty">Access denied.</div>';
        return;
      }
      if (!res.ok) {
        listEl.innerHTML = '<div class="fb-empty">Failed to load feedback.</div>';
        return;
      }

      const items = await res.json();
      countEl.textContent = items.length + ' item' + (items.length !== 1 ? 's' : '');

      if (items.length === 0) {
        listEl.innerHTML = '<div class="fb-empty">No feedback found.</div>';
        return;
      }

      listEl.innerHTML = items.map(item => {
        const date = new Date(item.created_at + 'Z').toLocaleString();
        const screenshotHtml = item.screenshot_path
          ? '<img class="fb-screenshot-thumb" src="/api/feedback/admin/' + item.id + '/screenshot" onclick="window.open(this.src,\'_blank\')" alt="screenshot">'
          : '';
        const pageLink = item.page_url
          ? '<a href="' + esc(item.page_url) + '" target="_blank">' + esc(item.page_url.substring(0, 60)) + '</a>'
          : '';

        return '<div class="fb-card" id="fb-' + item.id + '">' +
          '<div class="fb-card-header">' +
            '<div class="fb-meta">' +
              '<span class="fb-badge cat-' + item.category + '">' + item.category + '</span>' +
              '<span class="fb-badge sev-' + item.severity + '">' + item.severity + '</span>' +
              '<span class="fb-badge st-' + item.status + '">' + item.status + '</span>' +
              '<span class="fb-email">' + esc(item.user_email || 'unknown') + '</span>' +
            '</div>' +
            '<span class="fb-date">' + date + '</span>' +
          '</div>' +
          '<div class="fb-message">' + esc(item.message) + '</div>' +
          (pageLink ? '<div class="fb-details">Page: ' + pageLink + '</div>' : '') +
          screenshotHtml +
          '<div class="fb-actions">' +
            (item.status !== 'reviewed' ? '<button class="btn btn-secondary btn-small" onclick="updateStatus(' + item.id + ',\'reviewed\')">Mark Reviewed</button>' : '') +
            (item.status !== 'closed' ? '<button class="btn btn-secondary btn-small" onclick="updateStatus(' + item.id + ',\'closed\')">Close</button>' : '') +
            (item.status === 'closed' ? '<button class="btn btn-secondary btn-small" onclick="updateStatus(' + item.id + ',\'new\')">Reopen</button>' : '') +
            '<button class="btn btn-danger btn-small" onclick="deleteFeedback(' + item.id + ')">Delete</button>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    async function updateStatus(id, status) {
      const res = await fetch('/api/feedback/admin/' + id, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: status })
      });
      if (res.ok) loadFeedback();
    }

    async function deleteFeedback(id) {
      if (!confirm('Delete this feedback permanently?')) return;
      const res = await fetch('/api/feedback/admin/' + id, { method: 'DELETE' });
      if (res.ok) loadFeedback();
    }

    function esc(text) {
      var d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    document.getElementById('filter-status').addEventListener('change', loadFeedback);
    document.getElementById('filter-category').addEventListener('change', loadFeedback);
    document.getElementById('filter-severity').addEventListener('change', loadFeedback);
    var searchTimer;
    document.getElementById('filter-search').addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(loadFeedback, 300);
    });

    loadFeedback();
  </script>
</body>
</html>
